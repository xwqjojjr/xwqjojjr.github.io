
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Eth数据结构 | 徐文起写字的地方</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="WenqiXu">
    
    <meta name="description" content="Eth数据结构Header 和 Block123456789101112131415161718192021222324一个完整的区块 块号 666666&amp;gt; web3.eth.getBlock(666666)&amp;#123;  difficulty: 7346370067860,  extraDa">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="徐文起写字的地方" title="徐文起写字的地方"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="徐文起写字的地方">徐文起写字的地方</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:xuwenqi.info">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/04/03/Eth数据结构/" title="Eth数据结构" itemprop="url">Eth数据结构</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://xuwenqi.info" title="WenqiXu">WenqiXu</a>
    </p>
  <p class="article-time">
    <time datetime="2018-04-02T16:00:00.000Z" itemprop="datePublished">2018-04-03</time>
    Updated:<time datetime="2018-04-04T01:07:11.547Z" itemprop="dateModified">2018-04-04</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Eth数据结构"><span class="toc-number">1.</span> <span class="toc-text">Eth数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Header-和-Block"><span class="toc-number">1.1.</span> <span class="toc-text">Header 和 Block</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header-go-ethereum-core-types-block-go"><span class="toc-number">1.1.1.</span> <span class="toc-text">Header /go-ethereum/core/types/block.go</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Block-go-ethereum-core-types-block-go"><span class="toc-number">1.2.</span> <span class="toc-text">Block /go-ethereum/core/types/block.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Account-go-ethereum-core-state-state-object-go"><span class="toc-number">1.3.</span> <span class="toc-text">Account /go-ethereum/core/state/state_object.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transaction-go-ethereum-core-types-transaction-go"><span class="toc-number">1.4.</span> <span class="toc-text">Transaction /go-ethereum/core/types/transaction.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#txdata-go-ethereum-core-types-transaction-go"><span class="toc-number">1.5.</span> <span class="toc-text">txdata /go-ethereum/core/types/transaction.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Receipt-go-ethereum-core-types-receipt-go"><span class="toc-number">1.6.</span> <span class="toc-text">Receipt /go-ethereum/core/types/receipt.go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#未确认的交易"><span class="toc-number">2.</span> <span class="toc-text">未确认的交易</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#txpool-go"><span class="toc-number">2.1.</span> <span class="toc-text">txpool.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文献："><span class="toc-number">2.2.</span> <span class="toc-text">参考文献：</span></a></li></ol></li></ol>
		</div>
		
		<h1 id="Eth数据结构"><a href="#Eth数据结构" class="headerlink" title="Eth数据结构"></a>Eth数据结构</h1><h2 id="Header-和-Block"><a href="#Header-和-Block" class="headerlink" title="Header 和 Block"></a>Header 和 Block</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">一个完整的区块 块号 666666</span><br><span class="line">&gt; web3.eth.getBlock(666666)</span><br><span class="line">&#123;</span><br><span class="line">  difficulty: 7346370067860,</span><br><span class="line">  extraData: "0xd783010203844765746887676f312e342e32856c696e7578",</span><br><span class="line">  gasLimit: 3141592,</span><br><span class="line">  gasUsed: 84000,</span><br><span class="line">  hash: "0xf839b16b6d47c9e4bcd4e6359c80f0ab8585dc99c60cc239e8be2dab8e2c1b80",</span><br><span class="line">  logsBloom: "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",</span><br><span class="line">  miner: "0x52bc44d5378309ee2abf1539bf71de1b7d7be3b5",</span><br><span class="line">  mixHash: "0x3367c9453ef954635d7539ad510c9c411e27e7e659221635dda4777d29baee34",</span><br><span class="line">  nonce: "0x4cddceaa36d24f3e",</span><br><span class="line">  number: 666666,</span><br><span class="line">  parentHash: "0x36a7bd69e7877633dae44e9956b600ad5ba1525b3fb5ff5aecb89cbaccd09072",</span><br><span class="line">  receiptsRoot: "0x5df244abec075d8cf01a14e6718bcbb218b885fc9604e633eab4b9c26606676d",</span><br><span class="line">  sha3Uncles: "0x8ec3798ad82b719fb65e41a695f8e5bcd3505ee7da86035612571ce2585ad84e",</span><br><span class="line">  size: 1538,</span><br><span class="line">  stateRoot: "0x87782d701a99e4c6a74523b85d4bd396b692d04d6158aefc86f057b4bdcd2d54",</span><br><span class="line">  timestamp: 1449695074,</span><br><span class="line">  totalDifficulty: 3995968450696756125,</span><br><span class="line">  transactions: ["0x6f66fe5682aa6efb8c95f22df933efff169086322bc0319f50a4b2f873cf25d5", "0xae70c38e36b1979a287d607c0d9d31acb5fb96ef1d65a52576124ba1b8981075", "0xb788a4fe8a585d57d57fe20a6b5c07edee01aadfbdb3b17be99e83dc7f9f8420", "0xc5fe320da06c2b917c2c125e71d2511f45fa0ecef61e74bf40e3ac9b45c43817"],</span><br><span class="line">  transactionsRoot: "0x2525fe74ac7976da496481afe8e06f34ede6a919ea40c869e3d1d3b6e80cdc64",</span><br><span class="line">  uncles: ["0x4a60898eacf0c0a187815c84166145a891f7363551106530f817fe4ee24b6d62"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Header-go-ethereum-core-types-block-go"><a href="#Header-go-ethereum-core-types-block-go" class="headerlink" title="Header /go-ethereum/core/types/block.go"></a>Header /go-ethereum/core/types/block.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">ParentHash  common.Hash</span><br><span class="line">父块Hash</span><br><span class="line"></span><br><span class="line">UncleHash   common.Hash</span><br><span class="line">叔块Hash，当前区块的叔链列表的Hash</span><br><span class="line"></span><br><span class="line">Root        common.Hash</span><br><span class="line">状态字典树根节点Hash，交易打包到当前区块且区块定稿后生成这个值</span><br><span class="line"></span><br><span class="line">TxHash      common.Hash</span><br><span class="line">交易字典树根节点的Hash</span><br><span class="line"></span><br><span class="line">ReceiptHash common.Hash</span><br><span class="line">区块中的Transaction完成后会生成Receipt</span><br><span class="line"></span><br><span class="line">Bloom       Bloom</span><br><span class="line">用来快速判断一个参数的Log对象是否在一组已知的Log集合中</span><br><span class="line"></span><br><span class="line">Difficulty  *big.Int</span><br><span class="line">代表当前区块的难度，根据前一个区块的难度和时间戳计算得到</span><br><span class="line"></span><br><span class="line">Number      *big.Int</span><br><span class="line">区块的编号</span><br><span class="line"></span><br><span class="line">GasLimit    <span class="keyword">uint64</span></span><br><span class="line">每个区块的燃料消耗上限</span><br><span class="line"></span><br><span class="line">GasUsed     <span class="keyword">uint64</span></span><br><span class="line">当前区块的所有交易使用燃料之和</span><br><span class="line"></span><br><span class="line">Time        *big.Int</span><br><span class="line">当前区块初始化时的Unix时间戳</span><br><span class="line"></span><br><span class="line">Extra       []<span class="keyword">byte</span></span><br><span class="line">附加信息，<span class="number">32</span>字节以内的字节数组</span><br><span class="line"></span><br><span class="line">MixDigest   common.Hash</span><br><span class="line">混合Hash 与一个与随机数相关的<span class="number">256</span>位计算，用于证明当前区块已经完成足够的计算</span><br><span class="line"></span><br><span class="line">Nonce       BlockNonce</span><br><span class="line"><span class="number">64</span>位hash用于证明当前区块已经完成足够的计算</span><br></pre></td></tr></table></figure>
<p><strong>Header里面有三棵默克尔树，分别是表示账户状态的Root、表示交易状态的TxHash、表示收据的ReceiptHash，其中表示账户的默克尔树全网只有一棵，由所有节点共同维护，另外两棵树每个区块中都存在。</strong><br></p>
<p><strong>Root是系统状态hash，系统状态就是以太坊整个网络中所有账户的状态，它是一个merkle patricia trie结构。这个树并不存在于链上，而存在于节点的levelDB中。只有它的根hash存在于区块头Root中，每一个区块头里的Root都是区块被挖出确认时的快照，而world state指现在所有账户的状态。</strong><br></p>
<h2 id="Block-go-ethereum-core-types-block-go"><a href="#Block-go-ethereum-core-types-block-go" class="headerlink" title="Block /go-ethereum/core/types/block.go"></a>Block /go-ethereum/core/types/block.go</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">header       *Header</span><br><span class="line">区块头</span><br><span class="line">uncles       []*Header</span><br><span class="line">叔块头</span><br><span class="line">transactions Transactions</span><br><span class="line">交易数组</span><br><span class="line"></span><br><span class="line">// caches</span><br><span class="line">hash atomic.Value</span><br><span class="line">Block的哈希值，等于其Header成员的(RLP)哈希值。</span><br><span class="line">size atomic.Value</span><br><span class="line">区块的大小</span><br><span class="line"></span><br><span class="line">// Td is used by package core to store the total difficulty</span><br><span class="line">// of the chain up to and including the block.</span><br><span class="line">td *big.Int</span><br><span class="line">到目前区块的总难度</span><br><span class="line"></span><br><span class="line">// These fields are used by package eth to track</span><br><span class="line">// inter-peer block relay.</span><br><span class="line">ReceivedAt   time.Time</span><br><span class="line">ReceivedFrom interface&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xwqjojjr/MarkdownPhotos/blob/master/Header%E7%9A%84%E4%B8%89%E6%A3%B5%E6%A0%91.jpg?raw=true" alt="Header的三棵树"><br></p>
<h2 id="Account-go-ethereum-core-state-state-object-go"><a href="#Account-go-ethereum-core-state-state-object-go" class="headerlink" title="Account /go-ethereum/core/state/state_object.go"></a>Account /go-ethereum/core/state/state_object.go</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; eth.getBalance('0x651fb938bc292292efb1fcd782edb80eeb815aac')</span><br><span class="line"><span class="number">37622969961046506696</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nonce:随机数 等于账户发出的交易数加上账户创建的合约数量之和</span><br><span class="line"></span><br><span class="line">balance:余额，账户上拥有多少wei</span><br><span class="line"></span><br><span class="line">storageRoot:存储根节点，保存账户内容的MerklePatricia树根节点的256位Hash编码到字典树中</span><br><span class="line"></span><br><span class="line">codeHash:这个账户的EVM代码的hash值，代码执行时这个账户会介绍到一个消息调用，可以为空，此时账户称为非合约账户</span><br></pre></td></tr></table></figure>
<h2 id="Transaction-go-ethereum-core-types-transaction-go"><a href="#Transaction-go-ethereum-core-types-transaction-go" class="headerlink" title="Transaction /go-ethereum/core/types/transaction.go"></a>Transaction /go-ethereum/core/types/transaction.go</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; web3.eth.getTransaction('0x6f66fe5682aa6efb8c95f22df933efff169086322bc0319f50a4b2f873cf25d5');</span><br><span class="line">&#123;</span><br><span class="line">  blockHash: "0xf839b16b6d47c9e4bcd4e6359c80f0ab8585dc99c60cc239e8be2dab8e2c1b80",</span><br><span class="line">  blockNumber: 666666,</span><br><span class="line">  from: "0x52bc44d5378309ee2abf1539bf71de1b7d7be3b5",</span><br><span class="line">  gas: 25000,</span><br><span class="line">  gasPrice: 50000000000,</span><br><span class="line">  hash: "0x6f66fe5682aa6efb8c95f22df933efff169086322bc0319f50a4b2f873cf25d5",</span><br><span class="line">  input: "0x",</span><br><span class="line">  nonce: 117389,</span><br><span class="line">  r: "0xdd567242e55dc294b3a75d942fb735a726ed3c642dc7601405f84ff6daf5942c",</span><br><span class="line">  s: "0x414ea2c257f34b7a7ecd8988b0c2718363e1d0e368bd093726360be346959d22",</span><br><span class="line">  to: "0x651fb938bc292292efb1fcd782edb80eeb815aac",</span><br><span class="line">  transactionIndex: 0,</span><br><span class="line">  v: "0x1b",</span><br><span class="line">  value: 25153620976893014016</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data txdata</span><br><span class="line">交易，在下一段数据结构中详解</span><br><span class="line"></span><br><span class="line">hash atomic.Value</span><br><span class="line"></span><br><span class="line">size atomic.Value</span><br><span class="line"></span><br><span class="line">from atomic.Value</span><br><span class="line">发送者的地址</span><br></pre></td></tr></table></figure>
<h2 id="txdata-go-ethereum-core-types-transaction-go"><a href="#txdata-go-ethereum-core-types-transaction-go" class="headerlink" title="txdata /go-ethereum/core/types/transaction.go"></a>txdata /go-ethereum/core/types/transaction.go</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">AccountNonce uint64 json:<span class="string">"nonce"</span></span><br><span class="line">账户发出的交易数量,必须等于发起交易的账户的nonce,账户nonce是该账户发起的第几笔交易的序号，如果是创建合约则代表第几次创建合约的序号）</span><br><span class="line"></span><br><span class="line">Price  *big.Int json:<span class="string">"gasPrice"</span></span><br><span class="line">燃料价格，为执行的交易所付出的gas的价格</span><br><span class="line"></span><br><span class="line">GasLimit  uint64  json:<span class="string">"gas"</span></span><br><span class="line">燃料上限，用于执行交易的最大的gas数量</span><br><span class="line"></span><br><span class="line">Recipient  common.Hash  json:<span class="string">"to"</span></span><br><span class="line">接收者地址</span><br><span class="line"></span><br><span class="line">Amount *big.Int json:<span class="string">"input"</span></span><br><span class="line">转账额度</span><br><span class="line"></span><br><span class="line">Payload []<span class="keyword">byte</span> json:<span class="string">"input"</span></span><br><span class="line">如果交易类型是消息调用则Palyoad表示输入数据，</span><br><span class="line">例如消息的参数，假设有一个注册域名的合约服务，则Td就是该服务需要的参数如IP等。</span><br><span class="line"></span><br><span class="line">如果交易类型是创建合约，表示一段代码，</span><br><span class="line">这段代码用于创建合约账户，这段初始化代码只会被执行一次就丢弃掉，第二次执行的是创建完的合约代码体</span><br><span class="line"></span><br><span class="line">V *big.Int json:<span class="string">"v"</span></span><br><span class="line">R *big.Int json:<span class="string">"r"</span></span><br><span class="line">S *big.Int json:<span class="string">"s"</span></span><br><span class="line">和交易签名相关的变量，用于确定交易的发送者</span><br><span class="line"></span><br><span class="line">Hash *common.Hash json:<span class="string">"hash"</span></span><br><span class="line">交易序列rlp后的hash</span><br></pre></td></tr></table></figure>
<h2 id="Receipt-go-ethereum-core-types-receipt-go"><a href="#Receipt-go-ethereum-core-types-receipt-go" class="headerlink" title="Receipt /go-ethereum/core/types/receipt.go"></a>Receipt /go-ethereum/core/types/receipt.go</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; web3.eth.getTransactionReceipt('0x6f66fe5682aa6efb8c95f22df933efff169086322bc0319f50a4b2f873cf25d5')</span><br><span class="line">&#123;</span><br><span class="line">  blockHash: "0xf839b16b6d47c9e4bcd4e6359c80f0ab8585dc99c60cc239e8be2dab8e2c1b80",</span><br><span class="line">  blockNumber: 666666,</span><br><span class="line">  contractAddress: null,</span><br><span class="line">  cumulativeGasUsed: 21000,</span><br><span class="line">  from: "0x52bc44d5378309ee2abf1539bf71de1b7d7be3b5",</span><br><span class="line">  gasUsed: 21000,</span><br><span class="line">  logs: [],</span><br><span class="line">  logsBloom: "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",</span><br><span class="line">  root: "0x50b7e0ff8f0e1c47a4246328994eded2e58dfe9daa75c979de37f015005ee7d1",</span><br><span class="line">  to: "0x651fb938bc292292efb1fcd782edb80eeb815aac",</span><br><span class="line">  transactionHash: "0x6f66fe5682aa6efb8c95f22df933efff169086322bc0319f50a4b2f873cf25d5",</span><br><span class="line">  transactionIndex: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PostState []<span class="keyword">byte</span>  json:<span class="string">"root"</span>`</span><br><span class="line">Status            uint   json:<span class="string">"status"</span>`</span><br><span class="line">CumulativeGasUsed uint64 json:<span class="string">"cumulativeGasUsed"</span></span><br><span class="line">Bloom             Bloom  json:<span class="string">"logsBloom"</span></span><br><span class="line">Logs              []*Log json:<span class="string">"logs"</span></span><br><span class="line">TxHash          common.Hash    json:<span class="string">"transactionHash"</span></span><br><span class="line">ContractAddress common.Address json:<span class="string">"contractAddress"</span></span><br><span class="line">GasUsed         uint64         json:<span class="string">"gasUsed"</span></span><br></pre></td></tr></table></figure>
<h1 id="未确认的交易"><a href="#未确认的交易" class="headerlink" title="未确认的交易"></a>未确认的交易</h1><h2 id="txpool-go"><a href="#txpool-go" class="headerlink" title="txpool.go"></a>txpool.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">未确认的交易有<span class="number">4</span>中状态:未知Unkown、在队列中Queued、能够执行的交易Pending和包含的交易Included</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  TxStatusUnknown TxStatus = <span class="literal">iota</span></span><br><span class="line">  TxStatusQueued</span><br><span class="line">  TxStatusPending</span><br><span class="line">  TxStatusIncluded</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>txpool定义了区块链接口<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">提供必要的区块链信息</span><br><span class="line"><span class="keyword">type</span> blockChain <span class="keyword">interface</span> &#123;</span><br><span class="line">  CurrentBlock() *types.Block</span><br><span class="line">  GetBlock(hash common.Hash, number <span class="keyword">uint64</span>) *types.Block</span><br><span class="line">  StateAt(root common.Hash) (*state.StateDB, error)</span><br><span class="line">  SubscribeChainHeadEvent(ch <span class="keyword">chan</span>&lt;- ChainHeadEvent) event.Subscription</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>txpool定义了Txpool参数<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TxPoolConfig are the configuration parameters of the transaction pool.</span></span><br><span class="line"><span class="keyword">type</span> TxPoolConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">  NoLocals  <span class="keyword">bool</span>          <span class="comment">// Whether local transaction handling should be disabled</span></span><br><span class="line">    是否收听本地交易</span><br><span class="line">  Journal   <span class="keyword">string</span>        <span class="comment">// Journal of local transactions to survive node restarts</span></span><br><span class="line">    地址目录，本地的交易会被存在磁盘上，重启后重新执行</span><br><span class="line">  Rejournal time.Duration <span class="comment">// Time interval to regenerate the local transaction journal</span></span><br><span class="line">    生成本地事务日志的时间间隔</span><br><span class="line">  PriceLimit <span class="keyword">uint64</span> <span class="comment">// Minimum gas price to enforce for acceptance into the pool</span></span><br><span class="line">    在pool中接受的最小Gas</span><br><span class="line">  PriceBump  <span class="keyword">uint64</span> <span class="comment">// Minimum price bump percentage to replace an already existing transaction (nonce)</span></span><br><span class="line">    替换相同Nonce的交易的价格的百分比</span><br><span class="line">  AccountSlots <span class="keyword">uint64</span> <span class="comment">// Minimum number of executable transaction slots guaranteed per account</span></span><br><span class="line">    每个账户可执行事务的最小slots</span><br><span class="line">  GlobalSlots  <span class="keyword">uint64</span> <span class="comment">// Maximum number of executable transaction slots for all accounts</span></span><br><span class="line">    每个账户可执行事务的最大slots</span><br><span class="line">  AccountQueue <span class="keyword">uint64</span> <span class="comment">// Maximum number of non-executable transaction slots permitted per account</span></span><br><span class="line">    在交易槽中，每个账户不可执行的事务的最大值</span><br><span class="line">  GlobalQueue  <span class="keyword">uint64</span> <span class="comment">// Maximum number of non-executable transaction slots for all accounts</span></span><br><span class="line">    全局queueing的最大值</span><br><span class="line">  Lifetime time.Duration <span class="comment">// Maximum amount of time non-executable transaction are queued</span></span><br><span class="line">    在queue队列的最长等待时间</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Txpool包含所有的刚发现的交易，交易从网络或者本地进入txpool，当交易打包入块时离开txpool。<br><br>txpool主要用来存放当前提交的等待写入区块的交易，有远端和本地的。<br><br>txpool里面的交易分为两种，<br><br>1.提交但是还不能执行的，放在queue里面等待能够执行(比如说nonce太高)。<br><br>2.等待执行的，放在pending里面等待执行。<br><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TxPool <span class="keyword">struct</span> &#123;</span><br><span class="line">  config       TxPoolConfig</span><br><span class="line">    TxPool的配置参数</span><br><span class="line">  chainconfig  *params.ChainConfig</span><br><span class="line">    链的配置参数</span><br><span class="line">  chain        blockChain</span><br><span class="line">    之前定义的BlockChain</span><br><span class="line">  gasPrice     *big.Int</span><br><span class="line">    Gas的价格</span><br><span class="line">  txFeed       event.Feed</span><br><span class="line">    来订阅TxPool的消息</span><br><span class="line">  scope        event.SubscriptionScope</span><br><span class="line"></span><br><span class="line">  chainHeadCh  <span class="keyword">chan</span> ChainHeadEvent</span><br><span class="line">  chainHeadSub event.Subscription</span><br><span class="line">  订阅了区块头的消息，当有了新的区块头生成的时候会在这里收到通知</span><br><span class="line">  signer       types.Signer</span><br><span class="line">  区块头消息的订阅器。</span><br><span class="line">  mu           sync.RWMutex</span><br><span class="line"></span><br><span class="line">  currentState  *state.StateDB      <span class="comment">// Current state in the blockchain head</span></span><br><span class="line">  pendingState  *state.ManagedState <span class="comment">// Pending state tracking virtual nonces</span></span><br><span class="line">  currentMaxGas <span class="keyword">uint64</span>              <span class="comment">// Current gas limit for transaction caps</span></span><br><span class="line">  目前交易上限的GasLimit</span><br><span class="line">  locals  *accountSet <span class="comment">// Set of local transaction to exempt from eviction rules</span></span><br><span class="line">  本地交易免除驱逐规则</span><br><span class="line">  journal *txJournal  <span class="comment">// Journal of local transaction to back up to disk</span></span><br><span class="line">  本地交易会写入磁盘</span><br><span class="line">  pending <span class="keyword">map</span>[common.Address]*txList         <span class="comment">// All currently processable transactions</span></span><br><span class="line">  所有当前可以处理的交易</span><br><span class="line">  queue   <span class="keyword">map</span>[common.Address]*txList         <span class="comment">// Queued but non-processable transactions</span></span><br><span class="line">  当前还不能处理的交易</span><br><span class="line">  beats   <span class="keyword">map</span>[common.Address]time.Time       <span class="comment">// Last heartbeat from each known account</span></span><br><span class="line">  每一个已知账号的最后一次心跳信息的时间</span><br><span class="line">  all     <span class="keyword">map</span>[common.Hash]*types.Transaction <span class="comment">// All transactions to allow lookups</span></span><br><span class="line">  可以查找到所有交易</span><br><span class="line">  priced  *txPricedList                      <span class="comment">// All transactions sorted by price</span></span><br><span class="line">  按照价格排序的交易</span><br><span class="line"></span><br><span class="line">  wg sync.WaitGroup <span class="comment">// for shutdown sync</span></span><br><span class="line">  停止同步会用到的参数</span><br><span class="line">  homestead <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a><strong>参考文献：</strong></h2><p>[1] Ethereum源码<br></p>
<p><a href="https://github.com/ethereum/go-ethereum" target="_blank" rel="noopener">https://github.com/ethereum/go-ethereum</a><br></p>
<p>[2] go-ethereum-code-analysis<br></p>
<p><a href="https://github.com/ZtesoftCS/go-ethereum-code-analysis" target="_blank" rel="noopener">https://github.com/ZtesoftCS/go-ethereum-code-analysis</a><br></p>
<p>[3] [以太坊源代码分析] II. 数据的呈现和组织，缓存和更新<br></p>
<p><a href="https://blog.csdn.net/teaspring/article/details/75390210" target="_blank" rel="noopener">https://blog.csdn.net/teaspring/article/details/75390210</a><br></p>
<p>[4] 以太坊基础概念详解<br></p>
<p><a href="https://segmentfault.com/a/1190000013706670" target="_blank" rel="noopener">https://segmentfault.com/a/1190000013706670</a><br></p>
<p>[5] go-ethereum/core/tx_pool.go<br></p>
<p><a href="https://github.com/ethereum/go-ethereum/blob/master/core/tx_pool.go" target="_blank" rel="noopener">https://github.com/ethereum/go-ethereum/blob/master/core/tx_pool.go</a><br></p>
<p>[6] core-txpool交易池源码分析.md<br></p>
<p><a href="https://github.com/ZtesoftCS/go-ethereum-code-analysis/blob/master/core-txpool%E4%BA%A4%E6%98%93%E6%B1%A0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md" target="_blank" rel="noopener">https://github.com/ZtesoftCS/go-ethereum-code-analysis/blob/master/core-txpool%E4%BA%A4%E6%98%93%E6%B1%A0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md</a><br></p>
  
	</div>
		<footer class="article-footer clearfix">




<div class="article-share" id="share">

  <div data-url="http://xuwenqi.info/2018/04/03/Eth数据结构/" data-title="Eth数据结构 | 徐文起写字的地方" data-tsina="" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2018/03/26/以太坊学习笔记_9以太坊数据结构和schema设计/"  title="以太坊学习笔记_9 以太坊数据结构和schema设计">
 <strong>NEXT:</strong><br/> 
 <span>以太坊学习笔记_9 以太坊数据结构和schema设计
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Eth数据结构"><span class="toc-number">1.</span> <span class="toc-text">Eth数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Header-和-Block"><span class="toc-number">1.1.</span> <span class="toc-text">Header 和 Block</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header-go-ethereum-core-types-block-go"><span class="toc-number">1.1.1.</span> <span class="toc-text">Header /go-ethereum/core/types/block.go</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Block-go-ethereum-core-types-block-go"><span class="toc-number">1.2.</span> <span class="toc-text">Block /go-ethereum/core/types/block.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Account-go-ethereum-core-state-state-object-go"><span class="toc-number">1.3.</span> <span class="toc-text">Account /go-ethereum/core/state/state_object.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transaction-go-ethereum-core-types-transaction-go"><span class="toc-number">1.4.</span> <span class="toc-text">Transaction /go-ethereum/core/types/transaction.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#txdata-go-ethereum-core-types-transaction-go"><span class="toc-number">1.5.</span> <span class="toc-text">txdata /go-ethereum/core/types/transaction.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Receipt-go-ethereum-core-types-receipt-go"><span class="toc-number">1.6.</span> <span class="toc-text">Receipt /go-ethereum/core/types/receipt.go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#未确认的交易"><span class="toc-number">2.</span> <span class="toc-text">未确认的交易</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#txpool-go"><span class="toc-number">2.1.</span> <span class="toc-text">txpool.go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文献："><span class="toc-number">2.2.</span> <span class="toc-text">参考文献：</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  

  <div class="rsspart">
	<a href="" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2018 
		
		<a href="http://xuwenqi.info" target="_blank" title="WenqiXu">WenqiXu</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
